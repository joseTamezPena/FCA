---
title: "LUSC_CCA"
author: "Jose Tamez"
date: "2022-09-17"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library("FRESA.CAD")
library(readxl)

```


```{r}
signedlog <- function(x) { return (sign(x)*log(abs(x)+1.0e-12))}

```

## The parkison dataset
```{r}

pd_speech_features <- as.data.frame(read_excel("Data/pd_speech_features.xlsx",sheet = "pd_speech_features", range = "A2:ACB758"))

trainFraction=0.6;

```
## The average of the three repetitions

```{r}
rep1Parkison <- subset(pd_speech_features,RID==1)
rownames(rep1Parkison) <- rep1Parkison$id
rep1Parkison$id <- NULL
rep1Parkison$RID <- NULL
rep1Parkison[,1:ncol(rep1Parkison)] <- sapply(rep1Parkison,as.numeric)

rep2Parkison <- subset(pd_speech_features,RID==2)
rownames(rep2Parkison) <- rep2Parkison$id
rep2Parkison$id <- NULL
rep2Parkison$RID <- NULL
rep2Parkison[,1:ncol(rep2Parkison)] <- sapply(rep2Parkison,as.numeric)

rep3Parkison <- subset(pd_speech_features,RID==3)
rownames(rep3Parkison) <- rep3Parkison$id
rep3Parkison$id <- NULL
rep3Parkison$RID <- NULL
rep3Parkison[,1:ncol(rep3Parkison)] <- sapply(rep3Parkison,as.numeric)

whof <- !(colnames(rep1Parkison) %in% c("gender","class"));
avgParkison <- rep1Parkison;
avgParkison[,whof] <- (rep1Parkison[,whof] + rep2Parkison[,whof] + rep3Parkison[,whof])/3
#avgParkison[,whof] <- signedlog(avgParkison[,whof])
pander::pander(table(avgParkison$class))

```

## Correlation Matrix

```{r}
cormat <- cor(avgParkison,method="spearman")
gplots::heatmap.2(abs(cormat),
                  trace = "none",
                  scale = "none",
                  mar = c(10,10),
                  col=rev(heat.colors(5)),
                  main = "Raw Correlation",
                  cexRow = 0.75,
                  cexCol = 0.75,
                  key.title=NA,
                  key.xlab="Spearman Correlation",
                  xlab="Feature", ylab="Feature")



```


## Train and test set

```{r}
caseSet <- subset(avgParkison, class == 1)
controlSet <- subset(avgParkison, class == 0)
caseTrainSize <- nrow(caseSet)*trainFraction;
controlTrainSize <- nrow(controlSet)*trainFraction;
sampleCaseTrain <- sample(nrow(caseSet),caseTrainSize)
sampleControlTrain <- sample(nrow(controlSet),controlTrainSize)
trainSet <- rbind(caseSet[sampleCaseTrain,],controlSet[sampleControlTrain,])
testSet <- rbind(caseSet[-sampleCaseTrain,],controlSet[-sampleControlTrain,])
pander::pander(table(trainSet$class))
pander::pander(table(testSet$class))


```


```{r}

cvLASSORaw <- randomCV(avgParkison,
                "class",
                fittingFunction= LASSO_1SE,
                classSamplingType = "Au",
                trainFraction = 0.80,
                repetitions = 100,
                family="binomial"
)

bpraw <- predictionStats_binary(cvLASSORaw$medianTest,"LASSO RAW",cex=1.0)


cvLASSODeCor <- randomCV(avgParkison,
                "class",
                trainSampleSets= cvLASSORaw$trainSamplesSets,
                fittingFunction= filteredFit,
                fitmethod=LASSO_1SE,
                filtermethod=NULL,
                DECOR = TRUE,
#                DECOR.control=list(Outcome="class",type="RLM",method="spearman"),
                DECOR.control=list(Outcome="class"),
                family="binomial"
)

bpDecor <- predictionStats_binary(cvLASSODeCor$medianTest,"LASSO Decor",cex=1.0)

roc.test(bpDecor$ROC.analysis$roc.predictor,bpraw$ROC.analysis$roc.predictor)

```

```{r}

bm <- BSWiMS.model(class~.,avgParkison,loops=30,NumberofRepeats =20)
bpraw <- predictionStats_binary(cbind(avgParkison$class,predict(bm,avgParkison)),"BSWiMS RAW",cex=1.0)
bm$bagging$formulaNetwork
rawnames <- names(bm$bagging$bagged.model$coefficients)[-1]

decorp <- GDSTMDecorrelation(avgParkison,Outcome="class",method="spearman",type="RLM",verbose = TRUE)
bmd <- BSWiMS.model(class~.,decorp,loops=30,NumberofRepeats =20)
bpdraw <- predictionStats_binary(cbind(avgParkison$class,predict(bmd,decorp)),"BSWiMS Decor",cex=1.0)
cnames <- names(bmd$bagging$bagged.model$coefficients)[-1]
dc <- getDerivedCoefficients(decorp)
cnames_in_dc <- cnames[cnames %in% names(dc)]
unamedlist <- dc[cnames_in_dc]
print(unamedlist)

names(unamedlist) <- NULL

allvar <- unique(c(names(unlist(unamedlist)),cnames))
allvar <- allvar[!str_detect(allvar,"De_")]
allvar <- str_remove(allvar,"Ba_")
dvar <- allvar[!(allvar %in% rawnames)] 
print(dvar)

newvars <- character();
for (cvar in cnames_in_dc)
{
  lvar <- dc[cvar]
  names(lvar) <- NULL
  lvar <- names(unlist(lvar))
  if (length(lvar[lvar %in% dvar]) > 0)
  {
     newvars <- append(newvars,cvar)
  }
}

print(bm$univariate[dvar,])
print(bmd$univariate[newvars,])


roc.test(bpraw$ROC.analysis$roc.predictor,bpdraw$ROC.analysis$roc.predictor)

```

```{r}

cvBWRaw <- randomCV(avgParkison,
                "class",
                fittingFunction= BSWiMS.model,
                trainSampleSets= cvLASSORaw$trainSamplesSets
)


bpraw <- predictionStats_binary(cvBWRaw$medianTest,"BSWiMS RAW",cex=1.0)


cvBWDeCor2 <- randomCV(avgParkison,
                "class",
                fitmethod=BSWiMS.model,
                fittingFunction= filteredFit,
                trainSampleSets= cvLASSORaw$trainSamplesSets,
                filtermethod=NULL,
                DECOR = TRUE,
                DECOR.control=list(Outcome="class"),
)

bpDecor2 <- predictionStats_binary(cvBWDeCor2$medianTest,"BSWiMS Decor",cex=1.0)

roc.test(bpDecor2$ROC.analysis$roc.predictor,bpraw$ROC.analysis$roc.predictor)


```


