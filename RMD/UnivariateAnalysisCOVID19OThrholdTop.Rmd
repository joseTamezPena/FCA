---
title: "Univariate Options Threshold: Thermal COVID-19"
author: "Jose Tamez"
date: "`r Sys.Date()`"
output: 
  html_document: 
    toc: yes
    fig_caption: yes
    number_sections: yes
  word_document: 
    reference_docx: WordStyle_FRESA.docx
    toc: yes
    fig_caption: yes
editor_options:
  chunk_output_type: console
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(collapse = TRUE, warning = FALSE, message = FALSE,comment = "#>")
```

# Thermal Covid-19 Univariate

### Loading the libraries

```{r}
library("FRESA.CAD")
library(readxl)
op <- par(no.readonly = TRUE)
pander::panderOptions('digits', 3)
pander::panderOptions('table.split.table', 400)
pander::panderOptions('keep.trailing.zeros',TRUE)
signedlog <- function(x) { return (sign(x)*(abs(log10(abs(1.0e12*x)+1.0)-12.0)))}


```



## The Data

```{r}

SalivaThermal <- as.data.frame(read_excel("~/GitHub/FCA/Data/SalivaThermal_Source_Data_2.xlsx"))


SalivaThermal_set1 <- subset(SalivaThermal,RepID==1)
rownames(SalivaThermal_set1) <- SalivaThermal_set1$ID
SalivaThermal_set1$RepID <- NULL
SalivaThermal_set1$ID <- NULL
SalivaThermal_set1$Ct <- NULL

SalivaThermal_set2 <- subset(SalivaThermal,RepID==2)
rownames(SalivaThermal_set2) <- SalivaThermal_set2$ID
SalivaThermal_set2$RepID <- NULL
SalivaThermal_set2$ID <- NULL
SalivaThermal_set2$Ct <- NULL

SalivaThermal_set3 <- subset(SalivaThermal,RepID==3)
rownames(SalivaThermal_set3) <- SalivaThermal_set3$ID
SalivaThermal_set3$RepID <- NULL
SalivaThermal_set3$ID <- NULL
SalivaThermal_set3$Ct <- NULL

SalivaThermal_Avg <- (SalivaThermal_set1 + SalivaThermal_set2 + SalivaThermal_set3)/3

colnames(SalivaThermal_Avg) <- paste("V",colnames(SalivaThermal_Avg),sep="_")

SalivaThermal_Avg$class <- 1*(str_detect(rownames(SalivaThermal_Avg),"P"))


```


#### Standarize the names for the reporting

```{r results = "asis"}
dataframe <- SalivaThermal_Avg
outcome <- "class"
n_topfeatures <- 5
trainFraction <- 0.75
```



```{r results = "asis"}
pander::pander(c(rows=nrow(dataframe),col=ncol(dataframe)-1))
pander::pander(table(dataframe[,outcome]))

varlist <- colnames(dataframe)
varlist <- varlist[varlist != outcome]
varlist <- as.data.frame(cbind(name=varlist,desc=varlist))

```



## Threshold Analysis

```{r results = "asis", warning = FALSE, dpi=600, fig.height= 5.0, fig.width= 7.0}

toplist <- c(1:3)

univariate_columns <- c("caseMean","caseStd","controlMean","controlStd","cohortKSP","ROCAUC","WilcoxRes.p","FRes.p")

univar <- uniRankVar(varlist,
	           paste(outcome,"~1"),
	           outcome,
	           dataframe,
	           categorizationType = "Raw",
	           type = "LOGIT",
	           rankingTest = "AUC",
	            uniType = "Binary")

topnames <- c(outcome,univar$orderframe[toplist,"Name"])
topfivelm <- glm(paste(outcome,"~."),dataframe[,topnames],family="binomial")
print(summary(topfivelm))
bpraw <- predictionStats_binary(cbind(dataframe[,outcome],predict(topfivelm,dataframe)),"Logit RAW",cex=0.90)
par(op)

  accs <-bpraw$accc
  aucs <-bpraw$aucs
  bers <-bpraw$berror

optionNames <- character();
thrval <- 0.95
for (thrval in c(0.95,0.90,0.85,0.80,0.75,0.70,0.65,0.60,0.55,0.50))
{
  DEdataframe <- GDSTMDecorrelation(dataframe,Outcome=outcome,thr=thrval)
  tvarlist <-  colnames(DEdataframe)[colnames(DEdataframe) != "class"];
  tvarlist <- as.data.frame(cbind(name=tvarlist,desc=tvarlist))

  univar <- uniRankVar(tvarlist,
	           paste(outcome,"~1"),
	           outcome,
	           DEdataframe,
	           categorizationType = "Raw",
	           type = "LOGIT",
	           rankingTest = "AUC",
	            uniType = "Binary")

  nameopt <- paste("OD_At_",thrval,sep="");
  optionNames <- c(optionNames,nameopt)
  topnames <- c(outcome,univar$orderframe[toplist,"Name"])

  topfivelm <- glm(paste(outcome,"~."),DEdataframe[,topnames],family="binomial")
  print(summary(topfivelm))
  
  bppred <- predictionStats_binary(cbind(dataframe[,outcome],predict(topfivelm,DEdataframe)),nameopt,cex=0.90)

  aucs <- rbind(aucs,bppred$aucs)
  bers <- rbind(bers,bppred$berror)
  accs <- rbind(accs,bppred$accc)

}

rownames(aucs) <- c("raw",optionNames);
rownames(bers) <- c("raw",optionNames);
rownames(accs) <- c("raw",optionNames);
par(op)

```


### Error plots
```{r results = "asis", warning = FALSE, dpi=600, fig.height= 5.0, fig.width= 7.0}

  bpAUC <- barPlotCiError(as.matrix(aucs),
                          metricname = "ROC AUC: Top",
                          thesets = "AUC",
                          themethod = rownames(aucs),
                          main = "ROC AUC",
                          offsets = c(0.5,1),
                          scoreDirection = ">",
                          ho=0.5,
                          args.legend = list(bg = "white",x="bottomright",inset=c(0.0,0),cex=0.6),
                          col = terrain.colors(nrow(aucs))
                          )

pander::pander(as.data.frame(bpAUC$ciTable))

  bpACC <- barPlotCiError(as.matrix(accs),
                          metricname = "Accuracy: Top",
                          thesets = "Accuracy",
                          themethod = rownames(accs),
                          main = "Accuracy",
                          offsets = c(0.5,1),
                          scoreDirection = ">",
                          ho=0.5,
                          args.legend = list(bg = "white",x="bottomright",inset=c(0.0,0),cex=0.6),
                          col = terrain.colors(nrow(aucs))
                          )
  
  pander::pander(as.data.frame(bpACC$ciTable))

  bpBer <- barPlotCiError(as.matrix(bers),
                          metricname = "BER: Top",
                          thesets = "BER",
                          themethod = rownames(bers),
                          main = "BER",
                          offsets = c(0.5,1),
                          scoreDirection = "<",
                          ho=0.5,
                          args.legend = list(bg = "white",x="topleft",inset=c(0.0,0),cex=0.6),
                          col = terrain.colors(nrow(aucs))
                          )
  
    pander::pander(as.data.frame(bpBer$ciTable))


```


