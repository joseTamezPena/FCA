---
title: "FDeA and the GDSTM"
output:
  html_document:
    df_print: paged
editor_options:
  chunk_output_type: console
---

## Filtered ML fit and the GDSTM with FRESA.CAD

Here we make use of the **FRESA.CAD::filteredfit()** function to train ML models with and without GDSTM.

Naive-Bayes (NB) and LASSO models are used in this demo.

This scrip uses FRESA.CAD and mlbench R packages:

```{r functions,echo = TRUE }
knitr::opts_chunk$set(collapse = TRUE, warning = FALSE, message = FALSE,comment = "#>")

library("FRESA.CAD")
library(mlbench)

op <- par(no.readonly = TRUE)

```
### Sigend Log Transform

```{r}
signedlog <- function(x) { return (sign(x)*log(abs(x)+1.0e-12))}

```

I'll load the DARWIN data set

```{r}
DARWIN <- read.csv("~/GitHub/FCA/Data/DARWIN/DARWIN.csv")
rownames(DARWIN) <- DARWIN$ID
DARWIN$ID <- NULL
DARWIN$class <- 1*(DARWIN$class=="P")
print(table(DARWIN$class))

DARWIN[,1:ncol(DARWIN)] <- sapply(DARWIN,as.numeric)

whof <- !(colnames(DARWIN) %in% c("class"));
DARWIN[,whof] <- signedlog(DARWIN[,whof])


trainFraction=0.65;

```

## Correlation Matrix of the DARWIN Data

```{r results = "asis", warning = FALSE, dpi=600, fig.height= 6.0, fig.width= 8.0}
cormat <- cor(DARWIN,method="spearman")
gplots::heatmap.2(abs(cormat),
                  trace = "none",
                  scale = "none",
                  mar = c(10,10),
                  col=rev(heat.colors(5)),
                  main = "Raw Correlation",
                  cexRow = 0.75,
                  cexCol = 0.75,
                  key.title=NA,
                  key.xlab="Spearman Correlation",
                  xlab="Feature", ylab="Feature")



```


## Train and test set

```{r results = "asis", warning = FALSE, dpi=600, fig.height= 6.0, fig.width= 8.0}
set.seed(2)
caseSet <- subset(DARWIN, class == 1)
controlSet <- subset(DARWIN, class == 0)
caseTrainSize <- nrow(caseSet)*trainFraction;
controlTrainSize <- nrow(controlSet)*trainFraction;
sampleCaseTrain <- sample(nrow(caseSet),caseTrainSize)
sampleControlTrain <- sample(nrow(controlSet),controlTrainSize)
trainSet <- rbind(caseSet[sampleCaseTrain,], controlSet[sampleControlTrain,])
testSet <-  rbind(caseSet[-sampleCaseTrain,],controlSet[-sampleControlTrain,])
pander::pander(table(trainSet$class))
pander::pander(table(testSet$class))


```

## Decorrelation of train and test set creation
```{r results = "asis", warning = FALSE, dpi=600, fig.height= 6.0, fig.width= 8.0}
deTrain <- GDSTMDecorrelation(trainSet,Outcome="class",thr=0.8,verbose = TRUE)
deTest <- predictDecorrelate(deTrain,testSet)
dc <- getDerivedCoefficients(deTrain)

```

## Correlation Matrix of the Decorrelated Test Data

```{r results = "asis", warning = FALSE, dpi=600, fig.height= 6.0, fig.width= 8.0}
cormat <- cor(deTest,method="spearman")
gplots::heatmap.2(abs(cormat),
                  trace = "none",
                  scale = "none",
                  mar = c(10,10),
                  col=rev(heat.colors(5)),
                  main = "Test Set Correlation after GDSTM",
                  cexRow = 0.75,
                  cexCol = 0.75,
                  key.title=NA,
                  key.xlab="Spearman Correlation",
                  xlab="Feature", ylab="Feature")

```


## Cross Validation

```{r results = "asis", warning = FALSE, dpi=600, fig.height= 4.0, fig.width= 8.0}
par(op)
par(mfrow=c(1,2))

cvBSWiMSRaw <- randomCV(DARWIN,
                "class",
                fittingFunction= BSWiMS.model,
                classSamplingType = "Pro",
                trainFraction = trainFraction,
                repetitions = 150
)

bpraw <- predictionStats_binary(cvBSWiMSRaw$medianTest,"BSWiMS RAW",cex=0.80)


cvBSWiMSDeCor <- randomCV(DARWIN,
                "class",
                trainSampleSets= cvBSWiMSRaw$trainSamplesSets,
                fittingFunction= filteredFit,
                fitmethod=BSWiMS.model,
                filtermethod=NULL,
                DECOR = TRUE,
#                DECOR.control=list(Outcome="class",thr=0.8,type="RLM",method="spearman")
                DECOR.control=list(Outcome="class",thr=0.8)
)

bpDecor <- predictionStats_binary(cvBSWiMSDeCor$medianTest,"BSWiMS Decor",cex=0.80)

pander::pander(roc.test(bpDecor$ROC.analysis$roc.predictor,bpraw$ROC.analysis$roc.predictor))
par(op)

```

## The Raw Model vs the Decorrelated-Based Model

```{r results = "asis", warning = FALSE, dpi=600, fig.height= 4.0, fig.width= 8.0}
par(op)
par(mfrow=c(1,2))

bm <- BSWiMS.model(class~.,trainSet,NumberofRepeats = 10)
bpraw <- predictionStats_binary(cbind(testSet$class,predict(bm,testSet)),"BSWiMS RAW",cex=0.75)

bmd <- BSWiMS.model(class~.,deTrain,NumberofRepeats = 10)
bpdecor <- predictionStats_binary(cbind(deTest$class,predict(bmd,deTest)),"BSWiMS Decor",cex=0.75)

pander::pander(roc.test(bpraw$ROC.analysis$roc.predictor,bpdecor$ROC.analysis$roc.predictor))


par(op)

```

## Feature Analysis of Both Models

```{r results = "asis", warning = FALSE, dpi=600, fig.height= 6.0, fig.width= 8.0}
par(op)
par(mfrow=c(1,1))
rawnames <- names(bm$bagging$bagged.model$coefficients)[-1]
cnames <- names(bmd$bagging$bagged.model$coefficients)[-1]

cnames_in_dc <- cnames[cnames %in% names(dc)]
unamedlist <- dc[cnames_in_dc]
pander::pander(unamedlist)

names(unamedlist) <- NULL

allvar <- unique(c(names(unlist(unamedlist)),cnames))
allvar <- allvar[!str_detect(allvar,"De_")]
allvar <- str_remove(allvar,"Ba_")
dvar <- allvar[!(allvar %in% rawnames)] 
pander::pander(dvar)

newvars <- character();
for (cvar in cnames_in_dc)
{
  lvar <- dc[cvar]
  names(lvar) <- NULL
  lvar <- names(unlist(lvar))
  if (length(lvar[lvar %in% dvar]) > 0)
  {
     newvars <- append(newvars,cvar)
  }
}

pander::pander(bm$univariate[dvar,])
pander::pander(bmd$univariate[newvars,])
zvalueNew <- bmd$univariate[newvars,]
rownames(zvalueNew) <- str_remove(rownames(zvalueNew),"De_")
rownames(zvalueNew) <- str_remove(rownames(zvalueNew),"Ba_")

zvaluePrePost <- bm$univariate[rownames(zvalueNew),c(1,3)]
zvaluePrePost$Name <- NULL
zvaluePrePost$NewZ <- zvalueNew[rownames(zvaluePrePost),"ZUni"]
pander::pander(zvaluePrePost)
plot(zvaluePrePost,
     xlim=c(-0.5,6.5),
     ylim=c(0,7),
     xlab="Original Z",
     ylab="Decorrelated Z",
     main="Unviariate IDI Z Values",
     pch=3,cex=0.5,
     col="red")
abline(v=1.96,col="blue")
abline(h=1.96,col="blue")
text(zvaluePrePost$ZUni,zvaluePrePost$NewZ,rownames(zvaluePrePost),srt=65,cex=0.75)

sm <- summary(bmd)

pander::pander(sm$coefficients)

```

